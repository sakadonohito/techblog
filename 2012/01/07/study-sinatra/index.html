<!doctype html>
<html lang="ja">
	<head>
		<meta charset="UTF-8"/>
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1, user-scalable=yes">
		<title>開発メモてきな</title>
		<link rel="stylesheet" href="http://tech.k-zak.com/css/style.css" type="text/css"/>

	</head>
	<body>
		<div class="wrapper">
			<header class="site-main">
	<div class="header-image-main">
		<img alt="サイトのメインテーマ画像" src="http://tech.k-zak.com/image/top-min.png"/>
		<a href="http://tech.k-zak.com/" class="site-title">開発メモてきな</a>
	</div>
</header>

			<div class="main-part">
				
<main role="main">
	<div class="main-contents">
		<article class="main-content">
			<header>
				<h1>FileMakerとRubyのSinatra</h1>
				<ul class="horizontal-list-over767">
					<li>Published: 2012年01月07日</li>
				</ul>
				<p>Category:  <a href="http://tech.k-zak.com/categories/study-daily/">study-daily</a> </p>
			</header>
			<section>
				<p><p>Sinatraのチュートリアルを少し触って、これなら簡単にFileMakerと接続出来るんじゃない？</p>

<p>と思ったのでやってみました。</p>

<p>gihyo.jp:第９回 SinatraとSequel・Hamlで掲示板アプリを作る</p>

<p><a href="http://gihyo.jp/dev/serial/01/ruby/0009">http://gihyo.jp/dev/serial/01/ruby/0009</a></p>

<p>が自分がチュートリアル(以下、見本)としてやってみみたもので、これのmodel部分をFileMakerに</p>

<p>置換えました。</p>

<p>※FileMakerやRuby、Sinatraそのものの細かい説明は省きます。</p>

<p>最終的な階層は以下(見本のファイルも混在してます)</p>

<p>&#8212;</p>

<pre>app/
    start.rb
    model/
           comment.rb
    view /
           layout.haml
           index.haml
           fmbbs.haml
           style.sass</pre>

<p>&#8212;</p>

<p>FileMaker部分</p>

<p>・bbsテーブルの作成、カラムは見本のapp/model/comment.rb内で定義しているクラス</p>

<p>Commentsを真似て定義。但し、posted_dateはFileMaker側ではtimestamp型で作成時に自動で</p>

<p>現在のタイムスタンプが入るよう設定。</p>

<p>Ruby部分</p>

<p>・app/model/comment.rbにFileMakerとの接続クラス追加</p>

<p>&#8212;以下をcomment.rbに追加&#8212;</p>

<pre lang="ruby">require 'rfm'
class FMServer
  def initialize()
    @FM_CONFIG = {
      :host =&gt; "FileMakerServerの接続先IP",
      :account_name =&gt; "FileMakerFileのログインアカウント",
      :password =&gt; "FileMakerFileのログインパスワード",
      :database =&gt; "FileMakerFileの名前",
      :ssl =&gt; false,
      :root_cert =&gt; false,
    }
    @fm = Rfm::Server.new(@FM_CONFIG)
  end

  def listAll(lay,sortCond)
    return @fm[@FM_CONFIG[:database]][lay].all(sortCond)
  end

  def create(lay,obj)
    @fm[@FM_CONFIG[:database]][lay].create(obj)
  end
end</pre>

<p>・hamlを編集(追加)</p>

<p>&#8212;app/view/fmbbs.haml</p>

<pre>%form{:method=&gt;"POST",:action =&gt; '/fmcomment'}
  %input{:type=&gt;"hidden",:name=&gt;"_method",:value=&gt;"PUT"}
  %table
    %tr
      %td 名前
      %td
        %input{:type=&gt;"text",:name=&gt;"name"}
    %tr
      %td タイトル
      %td
        %input{:type=&gt;"text",:name=&gt;"title"}
    %tr
      %td 内容
      %td
        %textarea{:name=&gt;"message",:cols=&gt;60,:rows=&gt;8}
    %tr
      %td
      %td
        %input{:type=&gt;"submit"}

- @comments.each do |comment|
  .comment
    %h2= h comment.title
    .info
      %span.name== by #{h comment.name}
      %span.date== (#{timestamp_text(comment.posted_date)})

    .message
      == #{formatted_text(comment.message)}</pre>

<p>※HamlはPythonのようにインデントが文法になってるので注意！</p>

<p>・app/start.rbを編集</p>

<p>&#8212;app/start.rbを以下のように変更&#8212;</p>

<pre lang="ruby">#/usr/bin/ruby

require 'rubygems'
require 'sinatra'
require 'model/comment.rb'
require 'sass'

helpers do
  include Rack::Utils;alias_method :h, :escape_html
  #追加
  def timestamp_text(date)
    date.strftime("%Y/%m/%d %H:%M:%S")
  end
  #追加
  def formatted_text(text)
    Rack::Utils.escape_html(text).gsub(/n/,"")
  end
end

get '/style.css' do
  content_type 'text/css',:charset =&gt; 'utf-8'
  sass :style
end

get '/' do
  @comments = Comments.order_by(:posted_date.desc)
  haml :index
end

put '/comment' do
  Comments.create({
    :name =&gt; request[:name],
    :title =&gt; request[:title],
    :message =&gt; request[:message],
    :posted_date =&gt; Time.now,
  })
  redirect '/'
end

#追加
get '/fmbbs' do
  fm = FMServer.new
  @comments = fm.listAll("bbs",{:sort_field =&gt; "posted_date",:sort_order =&gt; 'descend'})
  haml :fmbbs
end

#追加
put '/fmcomment' do
  fm = FMServer.new
  obj = {
    :name =&gt; request[:name],
    :title =&gt; request[:title],
    :message =&gt; request[:message],
    #posted_dateは含めない
  }
  fm.create("bbs",obj)
  redirect '/fmbbs'
end</pre>

<p>・rfm(lardawge-rfm)をインストールするの忘れずに！</p>

<p>$ sudo gem install lardawge-rfm</p>

<p>GitHub：<a href="https://github.com/lardawge/rfm">https://github.com/lardawge/rfm</a></p>

<p>これでstart.rbのある位置をカレントにして</p>

<p>$ ruby -rubygems start.rb</p>

<p>これで</p>

<p><a href="http://localhost:4567/fmbbs">http://localhost:4567/fmbbs</a></p>

<p>で試せます。簡単ですね！</p>

<p>今回、自分がつまずいた所は、</p>

<p>１，rfm経由でFileMakerにレコード作成(多分編集も同じ)でtimestamp型のカラムに値を</p>

<p>設定するための方法が分からなかった。※DateTime型だとエラーになる、整形してもエラー</p>

<p>になる。なんでや！</p>

<p>→読み込みは出来るので、FileMaker側で作成時自動で値設定にした。</p>

<p>２，投稿済みデータの降順ソートがうまくいかない！</p>

<p>→lardawge-rfmでは降順の指定が&#8221;desc&#8221;ではなく、&#8221;descend&#8221;だった。</p>

<p>Railsでやるほどじゃないけどちょっと簡単にFileMakerとWebアプリつなぎたいとか、これで</p>

<p>どうでしょうか？</p>
</p>
			</section>
			<footer>
				<p>tags:  <a href="http://tech.k-zak.com/tags/filemaker/">#FileMaker</a>,  <a href="http://tech.k-zak.com/tags/ruby/">#Ruby</a>,  <a href="http://tech.k-zak.com/tags/sinatra/">#Sinatra</a>, </p>
			</footer>
		</article>
	</div>
</main>

				<aside>
	<div class="side-menu">
		<section>
			<p>Categories</p>
			<ul>
				
				<li><a href="http://tech.k-zak.com/categories/setting-construction">setting-construction</a>(37)</li>
				
				<li><a href="http://tech.k-zak.com/categories/study-daily">study-daily</a>(91)</li>
				
				<li><a href="http://tech.k-zak.com/categories/trouble-memo">trouble-memo</a>(6)</li>
				
			</ul>
		</section>
		<section>
			<p><a href="http://tech.k-zak.com/tags/">Tags</a></p>
			<ul>
				
				<li><a href="http://tech.k-zak.com/tags/ansible">ansible</a>(5)</li>
				
				<li><a href="http://tech.k-zak.com/tags/anyenv">anyenv</a>(1)</li>
				
				<li><a href="http://tech.k-zak.com/tags/apache">apache</a>(4)</li>
				
				<li><a href="http://tech.k-zak.com/tags/aws">aws</a>(4)</li>
				
				<li><a href="http://tech.k-zak.com/tags/aws-lambda">aws-lambda</a>(1)</li>
				
				<li><a href="http://tech.k-zak.com/tags/batch">batch</a>(1)</li>
				
				<li><a href="http://tech.k-zak.com/tags/bitgucket">bitgucket</a>(1)</li>
				
				<li><a href="http://tech.k-zak.com/tags/books">books</a>(1)</li>
				
				<li><a href="http://tech.k-zak.com/tags/bundler">bundler</a>(1)</li>
				
				<li><a href="http://tech.k-zak.com/tags/cakephp">cakephp</a>(3)</li>
				
				<li><a href="http://tech.k-zak.com/tags/character">character</a>(1)</li>
				
				<li><a href="http://tech.k-zak.com/tags/cmd">cmd</a>(1)</li>
				
				<li><a href="http://tech.k-zak.com/tags/codeigniter">codeigniter</a>(1)</li>
				
				<li><a href="http://tech.k-zak.com/tags/complain">complain</a>(5)</li>
				
				<li><a href="http://tech.k-zak.com/tags/css">css</a>(5)</li>
				
				<li><a href="http://tech.k-zak.com/tags/django">django</a>(3)</li>
				
				<li><a href="http://tech.k-zak.com/tags/docker">docker</a>(4)</li>
				
				<li><a href="http://tech.k-zak.com/tags/ec2">ec2</a>(3)</li>
				
				<li><a href="http://tech.k-zak.com/tags/ecs">ecs</a>(1)</li>
				
				<li><a href="http://tech.k-zak.com/tags/emacs">emacs</a>(4)</li>
				
				<li><a href="http://tech.k-zak.com/tags/env">env</a>(1)</li>
				
				<li><a href="http://tech.k-zak.com/tags/etc">etc</a>(1)</li>
				
				<li><a href="http://tech.k-zak.com/tags/fastcgi">fastcgi</a>(1)</li>
				
				<li><a href="http://tech.k-zak.com/tags/filemaker">filemaker</a>(4)</li>
				
				<li><a href="http://tech.k-zak.com/tags/fmxj">fmxj</a>(1)</li>
				
				<li><a href="http://tech.k-zak.com/tags/frontend">frontend</a>(2)</li>
				
				<li><a href="http://tech.k-zak.com/tags/fuelphp">fuelphp</a>(4)</li>
				
				<li><a href="http://tech.k-zak.com/tags/golang">golang</a>(1)</li>
				
				<li><a href="http://tech.k-zak.com/tags/groovy">groovy</a>(2)</li>
				
				<li><a href="http://tech.k-zak.com/tags/hexo">hexo</a>(2)</li>
				
				<li><a href="http://tech.k-zak.com/tags/html">html</a>(1)</li>
				
				<li><a href="http://tech.k-zak.com/tags/hugo">hugo</a>(3)</li>
				
				<li><a href="http://tech.k-zak.com/tags/iis">iis</a>(1)</li>
				
				<li><a href="http://tech.k-zak.com/tags/imap">imap</a>(1)</li>
				
				<li><a href="http://tech.k-zak.com/tags/java">java</a>(4)</li>
				
				<li><a href="http://tech.k-zak.com/tags/javascript">javascript</a>(13)</li>
				
				<li><a href="http://tech.k-zak.com/tags/jaws-ug">jaws-ug</a>(1)</li>
				
				<li><a href="http://tech.k-zak.com/tags/jekyll">jekyll</a>(2)</li>
				
				<li><a href="http://tech.k-zak.com/tags/jquery">jquery</a>(2)</li>
				
				<li><a href="http://tech.k-zak.com/tags/laravel4">laravel4</a>(1)</li>
				
				<li><a href="http://tech.k-zak.com/tags/log">log</a>(1)</li>
				
				<li><a href="http://tech.k-zak.com/tags/lolipopcloud">lolipopcloud</a>(1)</li>
				
				<li><a href="http://tech.k-zak.com/tags/mac">mac</a>(2)</li>
				
				<li><a href="http://tech.k-zak.com/tags/mackerel">mackerel</a>(2)</li>
				
				<li><a href="http://tech.k-zak.com/tags/markdown">markdown</a>(1)</li>
				
				<li><a href="http://tech.k-zak.com/tags/mastodon">mastodon</a>(1)</li>
				
				<li><a href="http://tech.k-zak.com/tags/mojolicious">mojolicious</a>(1)</li>
				
				<li><a href="http://tech.k-zak.com/tags/mojoliciouslite">mojoliciouslite</a>(1)</li>
				
				<li><a href="http://tech.k-zak.com/tags/movabletype">movabletype</a>(1)</li>
				
				<li><a href="http://tech.k-zak.com/tags/mysql">mysql</a>(3)</li>
				
				<li><a href="http://tech.k-zak.com/tags/netbeans">netbeans</a>(1)</li>
				
				<li><a href="http://tech.k-zak.com/tags/network">network</a>(1)</li>
				
				<li><a href="http://tech.k-zak.com/tags/nginx">nginx</a>(4)</li>
				
				<li><a href="http://tech.k-zak.com/tags/node.js">node.js</a>(1)</li>
				
				<li><a href="http://tech.k-zak.com/tags/ntp">ntp</a>(1)</li>
				
				<li><a href="http://tech.k-zak.com/tags/oracle">oracle</a>(1)</li>
				
				<li><a href="http://tech.k-zak.com/tags/otrs">otrs</a>(1)</li>
				
				<li><a href="http://tech.k-zak.com/tags/pelican">pelican</a>(2)</li>
				
				<li><a href="http://tech.k-zak.com/tags/perl">perl</a>(13)</li>
				
				<li><a href="http://tech.k-zak.com/tags/php">php</a>(21)</li>
				
				<li><a href="http://tech.k-zak.com/tags/postfix">postfix</a>(1)</li>
				
				<li><a href="http://tech.k-zak.com/tags/postgresql">postgresql</a>(4)</li>
				
				<li><a href="http://tech.k-zak.com/tags/powershell">powershell</a>(2)</li>
				
				<li><a href="http://tech.k-zak.com/tags/python">python</a>(15)</li>
				
				<li><a href="http://tech.k-zak.com/tags/rails">rails</a>(1)</li>
				
				<li><a href="http://tech.k-zak.com/tags/rbenv">rbenv</a>(2)</li>
				
				<li><a href="http://tech.k-zak.com/tags/react">react</a>(1)</li>
				
				<li><a href="http://tech.k-zak.com/tags/redmine">redmine</a>(3)</li>
				
				<li><a href="http://tech.k-zak.com/tags/redux">redux</a>(2)</li>
				
				<li><a href="http://tech.k-zak.com/tags/ruby">ruby</a>(13)</li>
				
				<li><a href="http://tech.k-zak.com/tags/s3">s3</a>(1)</li>
				
				<li><a href="http://tech.k-zak.com/tags/selenium">selenium</a>(1)</li>
				
				<li><a href="http://tech.k-zak.com/tags/sinatra">sinatra</a>(2)</li>
				
				<li><a href="http://tech.k-zak.com/tags/socket.io">socket.io</a>(1)</li>
				
				<li><a href="http://tech.k-zak.com/tags/ssh">ssh</a>(2)</li>
				
				<li><a href="http://tech.k-zak.com/tags/swift">swift</a>(1)</li>
				
				<li><a href="http://tech.k-zak.com/tags/symfony">symfony</a>(1)</li>
				
				<li><a href="http://tech.k-zak.com/tags/terraform">terraform</a>(1)</li>
				
				<li><a href="http://tech.k-zak.com/tags/typescript">typescript</a>(1)</li>
				
				<li><a href="http://tech.k-zak.com/tags/ubuntu">ubuntu</a>(6)</li>
				
				<li><a href="http://tech.k-zak.com/tags/unicorn">unicorn</a>(2)</li>
				
				<li><a href="http://tech.k-zak.com/tags/vagrant">vagrant</a>(3)</li>
				
				<li><a href="http://tech.k-zak.com/tags/vscode">vscode</a>(1)</li>
				
				<li><a href="http://tech.k-zak.com/tags/webpack">webpack</a>(1)</li>
				
				<li><a href="http://tech.k-zak.com/tags/windowsserver">windowsserver</a>(1)</li>
				
				<li><a href="http://tech.k-zak.com/tags/wkhtmltopdf">wkhtmltopdf</a>(1)</li>
				
				<li><a href="http://tech.k-zak.com/tags/wordpress">wordpress</a>(4)</li>
				
				<li><a href="http://tech.k-zak.com/tags/xcode">xcode</a>(1)</li>
				
				<li><a href="http://tech.k-zak.com/tags/zabbix">zabbix</a>(1)</li>
				
				<li><a href="http://tech.k-zak.com/tags/zend-framework">zend-framework</a>(1)</li>
				
			</ul>
		</section>
		<section>
			<p>Etc</p>
			<ul>
				<li>About</li>
			</ul>
		</section>
	</div>
</aside>

			</div>
			<footer>
	<small>Copyright &copy; 2012 sakadonohito All rights reserved.</small>
	<small>powered by Hugo.</small>
	<small>開発メモてきな</small>
</footer>

		</div>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.6/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script>
 (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
						  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
 })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
 ga('create', 'UA-46285513-1', 'auto');
 ga('send', 'pageview');
</script>


	</body>
</html>
